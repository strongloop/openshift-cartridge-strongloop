var settings = {
  minConn: 1,
  maxConn: 36,
  incrConn: 1,
  timeout: 10,
  host: 'demo.strongloop.com',
  database: 'XE',
  // tns: 'demo', // The tns can be //host:port/database, an tns name or ldap name
  user: 'boa',
  password: 'L00pBack',
  /*
   ldap: {
   adminContext: 'dc=strongloop,dc=com',
   host:'localhost',
   port: 1389,
   user:'cn=root',
   password:'secret'
   }*/
};

var path = require('path');
process.env.TNS_ADMIN = path.join(__dirname, 'admin');

var ora = require('../lib/oracle');
if(typeof ora === 'function') {
  ora = ora(settings);
}

// var sql = 'SELECT ID,POLICYNAMESPACEID,POLICYCONCERN,POLICYACTION,CHILDPOLICYNS,POLICYDEFAULT,DATAOWNER,LASTUPDATE,SETBY FROM DIS_POLICY_NAMESPACES';

var sql = 'SELECT * FROM DIS_POLICY_NAMESPACES';

ora.createConnectionPool(settings, function (err, pool) {
  if (err) {
    console.error(err);
    return;
  }
  var count = 5;
  var wait = count;
  for (var i = 0; i < count; i++) {
    console.log(i, sql);
    // console.log(pool.getInfo());
    pool.getConnection(function (err, conn) {
      conn.setAutoCommit(false);
      // console.log(pool.getInfo());
      var start = Date.now();
      conn.execute(sql, [], function (err, results) {
        if (err) {
          console.log(err);
        }
        console.log('Duration: %s ms', (Date.now() - start));
        console.log('Wait %d', wait);
        if (!err && results) {
          // console.log('Records found: %j', results);
        }
        conn.commit(function (err, result) {
          if (err) {
            console.log(err, result);
          }
          conn.close(function(err) {
            wait--;
          });
          // console.log(pool.getInfo());
          if (wait === 0) {
            console.log(pool.getInfo());
            pool.close(console.log);
          }
        });
      });
    });
  }
});
